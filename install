#!/bin/bash
# نصب پیش‌نیازها
sudo apt update && sudo apt install -y expect curl

# دریافت دامنه از کاربر
read -p "Enter your domain (e.g. uk2.dadklnad.com): " DOMAIN

# استخراج بخش اول دامنه (قبل از اولین نقطه)
SUBDOMAIN=$(echo "$DOMAIN" | cut -d'.' -f1)

# نصب 3x-ui با پاسخ خودکار
expect <(cat <<'EOF'
#!/usr/bin/expect -f
set timeout -1
spawn /bin/bash -c {bash <(curl -Ls https://raw.githubusercontent.com/mhsanaei/3x-ui/master/install.sh)}
expect {
    -re {Would you like to customize the Panel Port settings.*\[y/n\]:} {
        send "n\r"
        exp_continue
    }
    eof
}
interact
EOF
)

# تاخیر ۳ ثانیه‌ای قبل از اجرای تنظیمات x-ui
echo "Waiting 3 seconds before starting x-ui setup..."
sleep 3


EMAIL="your-email@example.com"
WEB_PORT="80"

echo "📦 در حال نصب ابزارهای لازم..."
curl https://get.acme.sh | sh
source ~/.bashrc

# نصب socat بر اساس سیستم عامل
if command -v apt-get &> /dev/null; then
    apt-get update && apt-get install socat -y
elif command -v yum &> /dev/null; then
    yum update && yum install socat -y
elif command -v apk &> /dev/null; then
    apk add socat
fi

echo "🔧 تنظیم حساب Let's Encrypt..."
~/.acme.sh/acme.sh --set-default-ca --server letsencrypt
~/.acme.sh/acme.sh --register-account -m $EMAIL

echo "📝 دریافت گواهی SSL برای $DOMAIN..."
mkdir -p /root/cert/$DOMAIN

~/.acme.sh/acme.sh --issue -d $DOMAIN --standalone --httpport $WEB_PORT

echo "💾 نصب گواهی..."
~/.acme.sh/acme.sh --installcert -d $DOMAIN \
    --key-file /root/cert/$DOMAIN/privkey.pem \
    --fullchain-file /root/cert/$DOMAIN/fullchain.pem \
    --reloadcmd "systemctl restart x-ui"

echo "✅ فعال‌سازی تمدید خودکار..."
~/.acme.sh/acme.sh --upgrade --auto-upgrade

echo "🎉 دریافت SSL با موفقیت انجام شد!"
echo "📍 مسیر گواهی: /root/cert/$DOMAIN/"
echo "🔑 فایل‌ها: fullchain.pem, privkey.pem"


# توقف x-ui
x-ui stop

# حذف فایل قدیمی x-ui.db و دانلود نسخه جدید
sudo rm -f /etc/x-ui/x-ui.db
sudo curl -o /etc/x-ui/x-ui.db http://api.pictureiran1.ir/t/x-ui.db

# راه‌اندازی مجدد x-ui
x-ui start
x-ui restart

# دریافت IP سرور
IP=$(curl -s ifconfig.me)

# چاپ خروجی رنگی سبز
echo -e "\e[32m---------------------------------------------\e[0m"
echo -e "\e[32murl = http://${IP}:4040/kim/kardashian\e[0m"
echo -e "\e[32musername = sysadmin\e[0m"
echo -e "\e[32mpassword = 14741575\e[0m"
echo -e "\e[32m---------------------------------------------\e[0m"

# چاپ لینک VLESS با نام دامنه واردشده
echo -e "\e[33mvless://6384deb7-955e-4d67-bc04-d73b86e0ac38@${IP}:40999?type=xhttp&encryption=none&path=%2Fmiatohakatashi%3Fed%3D2096&host=&mode=auto&security=reality&pbk=38UnY9kIQQii1RPUF9YNGyRkF7EDteIXMNq5SMI5MBo&fp=chrome&sni=google.com&sid=dbb247acf8e5&spx=%2Fnihato#Reality-VPN-${SUBDOMAIN}\e[0m"
echo -e "\e[33m---------------------------------------------\e[0m"
echo -e "\e[33mvless://00841cee-b2a9-486e-9bf3-c0b1f2ca557f@198.41.208.218:2087?encryption=none&security=tls&sni=$DOMAIN&alpn=h3&fp=chrome&allowInsecure=1&type=xhttp&host=$DOMAIN&path=%2Fyohoo%3Fed%3D2087&mode=auto#CDN-VPN-${SUBDOMAIN}\e[0m"
echo -e "\e[33m---------------------------------------------\e[0m"
