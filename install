#!/bin/bash
# Ù†ØµØ¨ Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§
sudo apt update && sudo apt install -y expect curl jq

# Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ù…Ù†Ù‡ Ø§Ø² Ú©Ø§Ø±Ø¨Ø±
read -p "Enter your domain (e.g. uk2.mrkheyrabadi.top): " DOMAIN



# Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨Ø®Ø´ Ø§ÙˆÙ„ Ø¯Ø§Ù…Ù†Ù‡ (Ù‚Ø¨Ù„ Ø§Ø² Ø§ÙˆÙ„ÛŒÙ† Ù†Ù‚Ø·Ù‡)
SUBDOMAIN=$(echo "$DOMAIN" | cut -d'.' -f1)
BASE_DOMAIN=$(echo "$DOMAIN" | awk -F. '{print $(NF-1)"."$NF}')


CLOUDFLARE_API_TOKEN="qx11xL7TOQ2e1Qg6Tw9eFrp3FlJRkSJUrKoymYxS"
ZONE_NAME="$BASE_DOMAIN"
IP=$(curl -s ifconfig.me)

# =========================
# Ú¯Ø±ÙØªÙ† Zone ID
# =========================
ZONE_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=${ZONE_NAME}" \
     -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
     -H "Content-Type: application/json" | jq -r '.result[0].id')

if [[ -z "$ZONE_ID" || "$ZONE_ID" == "null" ]]; then
  echo "âŒ Zone ID for ${ZONE_NAME} not found. Check your API token and domain."
  exit 1
fi

echo "âœ… Zone ID: $ZONE_ID"

# =========================
# Ø§ÛŒØ¬Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯ DNS Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¨â€ŒØ¯Ø§Ù…ÛŒÙ†
# =========================
RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/dns_records" \
     -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
     -H "Content-Type: application/json" \
     --data "{
       \"type\": \"A\",
       \"name\": \"${SUBDOMAIN}.${ZONE_NAME}\",
       \"content\": \"${IP}\",
       \"ttl\": 3600,
       \"proxied\": false
     }")

SUCCESS=$(echo "$RESPONSE" | jq -r '.success')

if [[ "$SUCCESS" == "true" ]]; then
  echo "âœ… Subdomain ${SUBDOMAIN}.${ZONE_NAME} successfully added â†’ IP: ${IP}"
else
  echo "âŒ Failed to add subdomain. Full response:"
  echo "$RESPONSE" | jq
  exit 1
fi


# Ù†ØµØ¨ 3x-ui Ø¨Ø§ Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯Ú©Ø§Ø±
expect <(cat <<'EOF'
#!/usr/bin/expect -f
set timeout -1
spawn /bin/bash -c {bash <(curl -Ls https://raw.githubusercontent.com/mhsanaei/3x-ui/master/install.sh)}
expect {
    -re {Would you like to customize the Panel Port settings.*\[y/n\]:} {
        send "n\r"
        exp_continue
    }
    eof
}
interact
EOF
)

# ØªØ§Ø®ÛŒØ± Û³ Ø«Ø§Ù†ÛŒÙ‡â€ŒØ§ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª x-ui
echo "Waiting 3 seconds before starting x-ui setup..."
sleep 3


# Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ù…â€ŒØ®ÙˆØ§Ù†ÛŒ IP Ø¯Ø§Ù…Ù†Ù‡
echo "â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„ Ø¯Ø§Ù…Ù†Ù‡..."
while true; do
    DOMAIN_IP=$(dig +short "$DOMAIN" | tail -n1)
    if [[ "$DOMAIN_IP" == "$IP" ]]; then
        echo "âœ… Ø¯Ø§Ù…Ù†Ù‡ ${DOMAIN} Ø¨Ø§ IP ${IP} Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ø´Ø¯!"
        break
    else
        echo "âŒ Ù‡Ù†ÙˆØ² Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ù†ÛŒØ³Øª. Ù…Ù‚Ø¯Ø§Ø± ÙØ¹Ù„ÛŒ IP Ø¯Ø§Ù…Ù†Ù‡: ${DOMAIN_IP:-N/A}"
        echo "â±ï¸ ØµØ¨Ø± Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… 3 Ø«Ø§Ù†ÛŒÙ‡ Ø¯ÛŒÚ¯Ø±..."
        sleep 3
    fi
done



EMAIL="your-email@example.com"
WEB_PORT="80"

echo "ğŸ“¦ Ø¯Ø± Ø­Ø§Ù„ Ù†ØµØ¨ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ù„Ø§Ø²Ù…..."
curl https://get.acme.sh | sh
source ~/.bashrc

# Ù†ØµØ¨ socat Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³ÛŒØ³ØªÙ… Ø¹Ø§Ù…Ù„
if command -v apt-get &> /dev/null; then
    apt-get update && apt-get install socat -y
elif command -v yum &> /dev/null; then
    yum update && yum install socat -y
elif command -v apk &> /dev/null; then
    apk add socat
fi

echo "ğŸ”§ ØªÙ†Ø¸ÛŒÙ… Ø­Ø³Ø§Ø¨ Let's Encrypt..."
~/.acme.sh/acme.sh --set-default-ca --server letsencrypt
~/.acme.sh/acme.sh --register-account -m $EMAIL

echo "ğŸ“ Ø¯Ø±ÛŒØ§ÙØª Ú¯ÙˆØ§Ù‡ÛŒ SSL Ø¨Ø±Ø§ÛŒ $DOMAIN..."
mkdir -p /root/cert/$DOMAIN

~/.acme.sh/acme.sh --issue -d $DOMAIN --standalone --httpport $WEB_PORT

echo "ğŸ’¾ Ù†ØµØ¨ Ú¯ÙˆØ§Ù‡ÛŒ..."
~/.acme.sh/acme.sh --installcert -d $DOMAIN \
    --key-file /root/cert/$DOMAIN/privkey.pem \
    --fullchain-file /root/cert/$DOMAIN/fullchain.pem \
    --reloadcmd "systemctl restart x-ui"

echo "âœ… ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ØªÙ…Ø¯ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±..."
~/.acme.sh/acme.sh --upgrade --auto-upgrade

echo "ğŸ‰ Ø¯Ø±ÛŒØ§ÙØª SSL Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!"
echo "ğŸ“ Ù…Ø³ÛŒØ± Ú¯ÙˆØ§Ù‡ÛŒ: /root/cert/$DOMAIN/"
echo "ğŸ”‘ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§: fullchain.pem, privkey.pem"


stop x-ui
echo "x-ui stop"

# Ø­Ø°Ù ÙØ§ÛŒÙ„ Ù‚Ø¯ÛŒÙ…ÛŒ x-ui.db Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ø³Ø®Ù‡ Ø¬Ø¯ÛŒØ¯
sudo rm -f /etc/x-ui/x-ui.db
sudo curl -o /etc/x-ui/x-ui.db http://api.pictureiran1.ir/t/x-ui.db




# Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ x-ui
start x-ui
echo "x-ui strat"

x-ui restart
echo "x-ui restrat"



# Ú†Ø§Ù¾ Ø®Ø±ÙˆØ¬ÛŒ Ø±Ù†Ú¯ÛŒ Ø³Ø¨Ø²
echo -e "\e[32m---------------------------------------------\e[0m"
echo -e "\e[32murl = http://${IP}:4040/kim/kardashian\e[0m"
echo -e "\e[32musername = sysadmin\e[0m"
echo -e "\e[32mpassword = 14741575\e[0m"
echo -e "\e[32m---------------------------------------------\e[0m"

# Ú†Ø§Ù¾ Ù„ÛŒÙ†Ú© VLESS Ø¨Ø§ Ù†Ø§Ù… Ø¯Ø§Ù…Ù†Ù‡ ÙˆØ§Ø±Ø¯Ø´Ø¯Ù‡
echo -e "\e[33mvless://6384deb7-955e-4d67-bc04-d73b86e0ac38@${IP}:40999?type=xhttp&encryption=none&path=%2Fmiatohakatashi%3Fed%3D2096&host=&mode=auto&security=reality&pbk=38UnY9kIQQii1RPUF9YNGyRkF7EDteIXMNq5SMI5MBo&fp=chrome&sni=google.com&sid=dbb247acf8e5&spx=%2Fnihato#Reality-VPN-${SUBDOMAIN}\e[0m"
echo -e "\e[33m---------------------------------------------\e[0m"
echo -e "\e[33mvless://00841cee-b2a9-486e-9bf3-c0b1f2ca557f@198.41.208.218:2087?encryption=none&security=tls&sni=$DOMAIN&alpn=h3&fp=chrome&allowInsecure=1&type=xhttp&host=$DOMAIN&path=%2Fyohoo%3Fed%3D2087&mode=auto#CDN-VPN-${SUBDOMAIN}\e[0m"
echo -e "\e[33m---------------------------------------------\e[0m"
